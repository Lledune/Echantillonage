---
title: "LSTAT2200"
author: "Lucien Ledune"
date: '`r format(Sys.time(), "%B %d, %Y,%H:%M")`'
output:
  pdf_document: # options pour sorties pdf
    toc: yes
    toc_depth: '3'
  html_document: # options pour sortie HTML
    code_folding: hide #  Cache le code  
    collapsed: yes # Cr?e un document unique 
    fig_caption: yes # Figures encapsul?es ? 
    fig_height: 5 # Hauteur par d?faut des figures
    fig_width: 6 # Largeur par d?faut des figure
    highlight: tango # style de mise en valeur du code
    number_sections: yes # Ajout table des mati?res 
    theme: united  # Style du document
    toc: yes # Table des matiere ?
    toc_depth: 3  # Profondeur table des mati?re
    toc_float: yes # table des mati?re flottante
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(sampling)
library(samplingbook) # Si chargement du package nécessaire : install.packages("samplingbook")
library(datasets)
library(pander)
library(knitr)
```

#Introduction 

Dans le cadre du cours d'échantillonage et sondage, nous allons réaliser un projet résumant la matière vue au cours. Ce travail sera divisé en plusieurs parties : 

* Un descriptif de la problématique
* La description des méthodes de sondages utilisées 
* Les statistiques descriptives de nos différents sondages 
* Une discussion sur les résultats
* Une discussion sur les limites de notre approche et comment l'améliorer

##Jeu de données 

Pour ce travail nous utiliserons le jeu de données **Legoland** qui représente la consommation de poivrons des habitants de Legoland. Legoland se divise en trois provinces, et les principaux supermarchés vendant les poivrons sont eux aussi au nombre de trois. Les habitants se nourrissent de poivrons de trois différentes sortes : Rouje, jaune et vert. 

Une ligne représente une transaction, que l'on peut associer à la consommation de poivrons d'un ménage au cours d'une journée. 

Voici les différentes variables : 

Province : La province dans laquelle la transaction a été effectuée. 

Enseigne : Le supermarché dans lequel elle a été faite. 

Paiement : Le type de paiement 

Vert, jaune, rouge : La quantité de poivrons de chaque type achetée. 

N_Personnes : Nombre de personnes au sein du ménage. 

Il faut garder à l'esprit que même si nous avons la base de donnée pour ce projet, nous ne pouvons pas nous en servir directement puisque le but est d'échantilloner. Nous disposons cependant de certaines informations comme les effectifs des provinces et des enseignes. (Voir mail de Vincent Bremhorst).

##Contraintes 

* Chaque province de Legoland doit être représentée dans l'échantillon, ainsi que chaque enseigne dans chaque province. 
* L'obtention des informations à un coût : 1$, 1.2$ et 1.5$ pour Grancub, P'ti rond et Toupla. 

* Le budget pour chaque échantillon est de 25000$.

##Questions de l'étude 

Nous allons tenter de répondre à 4 questions principales au cours de ce travail : 

* Quel type de poivron est le plus consommé à Legoland ? 
* La consommation de poivrons est-elle homogène au sein des trois provinces ? 
* Le chiffre d'affaire diffère-t-il au sein des chaines de supermarchés ? 
* Est-ce que l'installation de terminaux pour le paiement électronique serait rentable ? 

#Quel type de poivron est le plus consommé à Legoland ? 

##Échantillonage et calculs

Puisque dans cette question nous ne nous intéressons pas aux différents groupes mais bien à la totalité de la population, un sondage aléatoire sans remise devrait être efficace. 



```{r}
#load data
data = load(file = "c:/users/lucien/desktop/sondage/Poivron_legoland.rda")
#ordonne la db en fonction de la province et enseigne
Poivron_Legoland = Poivron_Legoland[order(Poivron_Legoland$Province, Poivron_Legoland$Enseigne),]

set.seed(5)
#plan aléatoire sans remise
N = length(Poivron_Legoland$Province) #total pop
n = 19250
srs = srswor(n, N)
dataSrswor = Poivron_Legoland[srs == 1,]

#Fonction de cout d'un échantillon : 
cost = function(tab){
  cost = 0
  levels = levels(Poivron_Legoland$Enseigne)
  for(i in 1:length(tab[,1])){
    if(tab[i,2] == levels[1]){
      cost = cost + 1 
    }else if(tab[i,2] == levels[2]){
      cost = cost + 1.2
    }else{
      cost = cost + 1.5
    }
  }  
  return(cost*1.05)
}

```

Premièrement nous allons constituer notre échantillon. Celui-ci sera fait grâce à la fonction $srswor$ afin de prendre 19250 échantillons. 

Nous allons ensuite vérifier si celui-ci ne dépasse pas la limite de coûts, auquel cas nous devrions revoir ce chiffre à la baisse. 

```{r}
cost(dataSrswor) #24913$
```

Nous sommes juste en dessous de la limite, nous pouvons donc conserver cet échantillon pour l'analyse. 

Nous allons maintenant vérifier si cet échantillon représente bien les trois enseignes et les trois provinces. Pour ce faire nous allons afficher calculer les tables de proportions des provinces ainsi que des enseignes de la population (dont nous connaissons les totaux à priori) et les comparer avec les proportions de notre échantillon. Nous pourrons ensuite afficher la différence de ces proportions entre l'échantillon et l'information à priori pour voir si nous en sommes proche. 


```{r}
#calcul des proportions dans les variables Province et Enseigne de la db
propP = prop.table(table(Poivron_Legoland$Province))
propE = prop.table(table(Poivron_Legoland$Enseigne))

#calcul dans notre échantillon 
propPe = prop.table(table(dataSrswor$Province))
propEe = prop.table(table(dataSrswor$Enseigne))

#affichage
pander(propPe - propP, caption = "Différence de proportion dans les provinces")
pander(propEe - propE, caption = "Différence de proportion dans les enseignes")

```

En effet il semble que les proportions soient bien respectées. Nous pouvons également afficher la table croisée de notre échantillon : 

```{r}
pander(table(dataSrswor$Province, dataSrswor$Enseigne), caption = "Table croisée de l'échantillon")
```

L'échantillon étant maintenant constitué et validé nous pouvons maintenant répondre à la question en faisant la somme des achats des différents types de poivrons de l'échantillon : 

```{r}
#Nous pouvons maintenant nous intéresser à la question puisque l'échantillon est constitué. 
poivrons = 0
for(i in 4:6){
  poivrons[i-3] = sum(dataSrswor[,i])
}
poivrons = t(poivrons)
poivrons = as.data.frame(poivrons)
colnames(poivrons) = c("vert", "jaune", "rouge")
pander(poivrons, caption = "Consommation de poivron de l'échantillon")
```

##Discussion 

Comme nous le voyons très bien ici, les poivrons rouges sont largement majoritaires avec plus de 333.000 poivrons consommés. Les deux autres types de poivrons sont assez similaire dans leurs ventes avec 163636 et 161140 en faveur des poivrons jaunes. Cette information pourrait être intéressante pour la détermination des prix des poivrons, car elle nous informe sur la demande de ceux-ci. Cependant avant de prendre une conclusion trop hâtive nous allons aller plus loin en regardant si cette consommation est homogène entre les différentes provinces.

#Est-ce que la consommation de poivron est homogène au sein des trois provinces de Legoland ? 

Nous allons maintenant nous intéresser à la deuxième question principale de ce projet, et tenter de déterminer si la consommation de poivrons est homogène au sein des trois provinces de Legoland. 

Pour cette question nous pouvons changer notre plan de sondage. 

Nous devons ici bien nous assurer que les trois provinces sont bien représentées car nous voulons avant tout analyser l'homogénéité dans la consommation de poivrons au sein de celles-ci. 

Pour ce faire nous allons donc utiliser un échantillonage aléatoire à deux degrés afin de bien cibler notre étude. Comme nous disposons des totaux des différentes provinces nous pourrons nous en servir afin de quantifier les échantillons de chaque province que nous allons récupérer. Cela va nous permettre de sélectionner toutes les provinces et par la suite de choisir le nombre d'échantillon à récupérer dans chaque province. 

Nous allons pour le choix de ce nombre nous servir des proportions, que nous allons ensuite multiplier par une constakte $k$ permettant de se rapprocher des 25000$ de contrainte sans les dépasser afin de garantir la qualité de l'échantillon. 



```{r}
prop = prop.table(table(Poivron_Legoland$Province))
#Fix order for sample (care for seed) 
temp = prop[1]
prop[1] = prop[2]
prop[2] = temp

k = 19250

set.seed(5)
#Getting proportions
Sample <- mstage(Poivron_Legoland, stage=c("cluster",""), varnames=list("Province"), size=list(3,k*prop), method=c("srswor","srswor"))
echant2 = getdata(Poivron_Legoland, Sample)

cost(echant2[[2]]) #24951$

```

En effet nous restons bien dans les coûts avec 24951$. Nous allons maintenant regarder les provinces et les enseignes représentées dans notre échantillon. 

```{r}
pander(prop.table(table(Poivron_Legoland$Province)), caption = "Proportions de la population (données)")
pander(prop.table(table(echant2[[2]]$Province)), caption = "Proportions de l'échantillon")
pander(table(echant2[[2]]$Province), caption = "Compte des différentes provinces dans l'échantillon")
```

Nous voyons bien que les différentes proportions sont respectées. Regardons maintenant si les enseignes sont bien représentées. 

```{r}
pander(table(echant2[[2]]$Enseigne), caption = "Compte des enseignes de l'échantillon")
```


Encore une fois il est clair que les trois enseignes sont bien représentées dans l'échantillon, nous pouvons donc le valider et répondre à la question. 

Pour ce faire nous allons regarder les consommation des différents poivrons grâce à une équation "logique" pour bien séparer les provinces. 


```{r}
samp = echant2[[2]]

dfcons = as.data.frame(matrix(ncol = 4, nrow = 4))
colnames(dfcons) = c("Vert", "Jaune", "Rouge", "Somme")
rownames(dfcons) = c("Nord", "Centre", "Sud", "Somme")

#Get sums 
for(i in 4:6){
  dfcons[1, i-3] = sum(samp[samp$Province == "Nord", i])
  dfcons[2, i-3] = sum(samp[samp$Province == "Centre", i])
  dfcons[3, i-3] = sum(samp[samp$Province == "Sud", i])
}
for(i in 1:3){
  dfcons[i, 4] = sum(dfcons[i, ], na.rm = T)
  dfcons[4, i] = sum(dfcons[, i], na.rm = T)
}
dfcons[4, 4] = sum(sum(dfcons[,4], na.rm = T), sum(dfcons[4,], na.rm = T))

pander(dfcons, caption = "Consommation de poivrons par région")

```

##Discussion 

Le tableau ci-dessus mets en évidence plusieurs choses intéressantes. Premièrement, la consommation **totale** de poivrons au sein des différentes provinces semble en effet assez semblable avec 218713, 219581 et 220633. Cependant attention car si l'on observe la consommation par types de poivrons, celle-ci diffère énormément d'une province à l'autre. Ainsi : 

* Les trois provinces consomment une majorité de poivrons rouges. 
* La province du nord consomme plus de poivrons verts que les autres provinces mais moins de poivrons jaunes. 
* La province de centre consomme des poivrons verts et jaunes dans une quantité assez similaire. 
* La province du sud consomme plus de poivrons jaunes que les autres provinces mais moins de poivrons verts

Cette analyse nous permet donc très clairement de distinguer une hétérogénéité de la consommation des types de poivrons en fonction des provinces. 

#Le chiffre d'affaire diffère-t-il au sein des chaines de supermarchés ? 

Pour répondre à cette question il faut rappeler que le coût au kg des différents types de poivrons sont actuellement identiques, nous pouvons donc nous concentrer sur la quantité de poivrons vendus au sein de chaque enseigne. Ici encore nous connaissons les totaux de la population, nous pourrons donc nous servir de ces totaux pour obtenir un échantillon de la même proportion. 

Nous devons ici encore faire bien attention à prendre un échantillon aussi grand que possible tout en restant dans la limite, car comme les quantités achetées varient beaucup d'une transaction à l'autre nous devons tenter de nous rapprocher un maximum de la réalité en prenant autant de lignes que possible. 

Notre analyse ici va être très similaire à la précédente, à la différence près que ce n'est pas aux provinces que nous nous intéressons mais aux enseignes. Nous allons donc encore une fois utiliser les proportions des enseignes de la population (connues) pour répliquer celles-ci dans notre échantillon. 

Pour ce faire nous allons encore utiliser un échantillon à deux degrès : Premièrement une sélection des groupes, ensuite un échantillonage simple sans remise au sein de ces groupes en suivant les proportions de la population pour que les résultats collent un maximum à la réalité. 

```{r}
prop = prop.table(table(Poivron_Legoland$Enseigne))

k = 19275

set.seed(5)
#Getting proportions
Sample <- mstage(Poivron_Legoland, stage=c("cluster",""), varnames=list("Enseigne"), size=list(3,k*prop), method=c("srswor","srswor"))
echant3 = getdata(Poivron_Legoland, Sample)

cost(echant2[[2]]) #24951$
```

Encore une fois le coût de l'échantillon est de 24951$, nous respectons donc bien le budget. 

Regardons maintenant si les proportions sont bien respectées : 

```{r}
pander(prop.table(table(Poivron_Legoland$Enseigne)), caption = "Proportions de la population (données)")
pander(prop.table(table(echant3[[2]]$Enseigne)), caption = "Proportions de l'échantillon")
pander(table(echant3[[2]]$Enseigne), caption = "Compte des différentes enseignes dans l'échantillon")

```

En effet les proportions sont parfaitement respectées, comme attendu. 


Nous allons maintenant nous intéresser aux autres contraintes. Les provinces sont-elles bien représentées ? 

```{r}
echant3E = echant3[[2]]
pander(table(echant3E$Province), caption = "Compte des provinces dans l'échantillon")
```

Cela semble en effet être le cas. Il ne nous reste plus maintenant qu'à vérifier que chaque enseigne est bien représentée dans chaque province : 

```{r}
tab = table(echant3E$Province, echant3E$Enseigne)
tab = cbind(tab, Total = rowSums(tab))
tab = rbind(tab, Total = colSums(tab))
pander(tab, caption = "Tableau croisé de l'échantillon")
```

Il est clair que les enseignes sont bien représentées au vue des résultats de notre tableau croisé. 

L'échantillon étant maintenant validé nous allons répondre à la question qui est de déterminer si le chiffre d'affaire est le même parmis les trois enseignes. 

Puisque le prix au kg est identique pour chaque poivron et ce dans chaque enseigne, nous pouvons considérer qu'1kg coûte 1$, ce qui simplifiera grandement les calculs car nous ne devrons pas nous soucier du prix dans ceux-ci. 
La surface vendant le plus de kg de poivrons sera donc celle qui réalisera le meilleur chiffre d'affaire. 

Grâce à cette simplification, nous pouvons donc suivre exactement la même méthodologie que dans la question précédente, en étudiant les enseignes au lieu des provinces. 

Voici le tableau résultant de cette analyse : 

```{r}
samp = echant3[[2]]

dfcons = as.data.frame(matrix(ncol = 4, nrow = 4))
colnames(dfcons) = c("Vert", "Jaune", "Rouge", "Somme")
rownames(dfcons) = c("Grancub", "P'ti rond", "Toupla", "Somme")

#Get sums 
for(i in 4:6){
  dfcons[1, i-3] = sum(samp[samp$Enseigne == "Grancub", i])
  dfcons[2, i-3] = sum(samp[samp$Enseigne == "P'ti rond", i])
  dfcons[3, i-3] = sum(samp[samp$Enseigne == "Toupla", i])
}
for(i in 1:3){
  dfcons[i, 4] = sum(dfcons[i, ], na.rm = T)
  dfcons[4, i] = sum(dfcons[, i], na.rm = T)
}
dfcons[4, 4] = sum(sum(dfcons[,4], na.rm = T), sum(dfcons[4,], na.rm = T))

pander(dfcons, caption = "Consommation de poivrons par enseigne")
```

La première chose que nous notons est la similarité entre cette analyse et la précédente ! Les conclusions semblent très similaires, voici ce que nous pouvons noter : 

* Les trois enseignes semblent avoir un chiffre d'affaire relativement similaire, avec 215025, 219538 et 225065. Cela dit l'enseigne toupla semble tout de même en vendre légèrement plus que les autres, la différence étant de 10040 kg avec Grancub. 
* Le poivron rouge est celui qui rapporte le plus aux trois enseignes. 
* Grancub vends plus de poivrons jaunes que de poivrons verts.
* P'ti rond vend plus ou moins autant de poivrons jaunes que de poivrons verts.
* Toupla vend plus de poivrons verts que de poivrons jaunes. 










